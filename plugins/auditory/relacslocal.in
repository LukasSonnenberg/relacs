#! /usr/bin/env bash

###############################################################################
#
# relacs
#
# RELACS - RealTime ELectrophysiological data Acquisition, Control, and Stimulation
# Copyright (C) 2002-2008 Jan Benda <j.benda@biologie.hu-berlin.de>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
# 
# RELACS is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
###############################################################################


# default working path:
WORKPATH="."

# base of the config files (as passed to relacs by -s):
CONFIGBASE="relacs"

# default name of the log-file:
LOGFILE="relacs.log"
USELOGFILE="no"

# double log messages to stdout?
TEE="tee -a"
USETEE="no"

# debug:
DEBUG="no"
DEBUGRUN="no"
DEBUGGER="libtool --mode=execute gdb"
COREFILE=""

# email address for core dump and bug notifications:
EMAILADDRESS=""

# core dumps?
COREDUMP="no"
COREDIR="coredumps"
COREMAILSUBJ="RELACS coredump"

# bugs?
BUGS="no"
BUGDIR="bugs"
BUGMAILSUBJ="RELACS bug"

# kernel messages (from dmesg)?
KERNELMESSAGES="no"


# read arguments:
HELP="no";
for i; do
  case $1 in
    -s) shift
        CONFIGBASE="$1"
	shift ;;
    -w) shift
        if test "x$1" != "x"; then
          WORKPATH="$1"
          shift
        fi ;;
    -l) USELOGFILE="yes"
        shift
	if test "x${1:0:1}" != "x-"; then
          LOGFILE=$1
	  shift
	fi ;;
    -t) USELOGFILE="yes"
        USETEE="yes"
        shift ;;
    -d) DEBUG="yes"
        DEBUGRUN="no"
        USELOGFILE="no"
        shift ;;
    -D) DEBUG="yes"
        DEBUGRUN="yes"
        USELOGFILE="no"
        shift ;;
    -C) shift
        if test "x$1" != "x"; then
          COREFILE="$1"
          DEBUG="yes";
          USELOGFILE="no"
          shift
        fi ;;
    -c) COREDUMP="yes"
        ulimit -c unlimited 
        USELOGFILE="yes"
        shift ;;
    -b) BUGS="yes"
        USELOGFILE="yes"
        shift ;;
    -k) KERNELMESSAGES="yes"
        shift ;;
    -m) shift
        EMAILADDRESS="$1" 
        shift ;;
    -h) HELP="yes"
        break ;;
--help) HELP="yes"
        break ;;
  '-?') HELP="yes"
        break ;;
    --) break ;;
     *) break ;;
  esac
done


# print help:
if test "x$HELP" = "xyes"; then
  RELACSSCRIPT=${0##*/}
  echo "$RELACSSCRIPT"
  echo
  echo "Script for running RELACS"
  echo "Jan Benda, 2003-2008"
  echo
  echo "Usage:"
  echo "  $RELACSSCRIPT [options]"
  echo
  echo "Options:"
  echo "  -w DIRECTORY   Working path (default '$WORKPATH')"
  echo "  -l [FILE]      Write RELACS messages from stdout and stderr to the log-file"
  echo "                 FILE (default '$LOGFILE')"
  echo "  -t             Use log file but also write messages to stdout "
  echo "  -d             Run RELACS from within a debugger (disables logfile)"
  echo "  -D             Start debugger without running RELACS"
  echo "  -C FILE        Start debugger with core-dump file FILE"
  echo "  -c             Save core dump in directory '$COREDIR' (enables -l)"
  echo "  -b             In case of warnings or errors, save log file in directory"
  echo "                 '$BUGDIR' (enables -l)"
  echo "  -k             In case of core dumps or bugs save the output of dmesg as well"
  echo "  -m EMAIL       Email notification about core dumps or bugs to EMAIL"
  echo "                 (default '$EMAILADDRESS')"
  echo "  --             The following options are passed directly"
  echo "                 to the RELACS executable"
  echo
  echo "  -3             Run in simulation mode"
  echo "  -s BASE        Use BASE as the basename for the RELACS settings"
  echo "                 (configuration) files (default is 'relacs',"
  echo "                 i.e. relacs.cfg and relacsplugins.cfg)"
  echo "  -f             Run RELACS in fullscreen mode"
  echo
  echo "  --help         Print this help message and exit."
  echo "  --version      Print the version number of RELACS and exit."
  echo
  exit 0
fi


SEPARATOR=AJ3S4G5U

# full path of the RELACS executable to be used:
RELACSEXEC="@abs_top_builddir@/src/relacsgui"

# pathes to the RELACS libraries:
RELACSLIBPATHS="@abs_top_builddir@/daq/src/.libs\
:@abs_top_builddir@/datafile/src/.libs\
:@abs_top_builddir@/mplot/src/.libs\
:@abs_top_builddir@/numerics/src/.libs\
:@abs_top_builddir@/options/src/.libs\
:@abs_top_builddir@/widgets/src/.libs:"

PLUGINHOME=@abs_top_builddir@

# possible locations of config files,
# must be separated by '|':
CONFDIR_CANDIDATES='@abs_builddir@'
### shouldn't that be better full file names? or both?
# default config files could/should sit in
# /etc/relacs/relacs.cfg
# /usr/share/relacs.cfg
# ~/.relacs/relacs.cfg
# ~/.relacs/myrelacs.cfg
# $WORKPATH/myrelacs.cfg
# /aa/bb/ccc/myrelacs.cfg


CONFFILE=${CONFIGBASE}.cfg

# We need the config file for the pluginpathes!
# start out from the user defined config file
# then the default config files
# stop es soon a config file with an pluginpath entry is found!!!

## Find config file location
#while read i ; do
#    if test -f "${i}/${CONFFILE}"; then
#        CONFDIR=${i}
#        break
#    fi
#done < <(sed "s/${SEPARATOR}/\n/g" <<< ${CONFDIR_CANDIDATES})
SAVEIFS="$IFS"
IFS="|"
for i in $CONFDIR_CANDIDATES; do
    if test -f "${i}/${CONFFILE}"; then
        CONFDIR=${i}
        break
    fi
done
IFS="$SAVEIFS"
if test "x${CONFDIR}" = x; then
    echo "${CONFFILE} not found" 1>&2
    exit 1
fi
CONFPART="${CONFDIR}/${CONFIGBASE}"
#echo "Using config from ${CONFDIR}"


## Find all directories we need to link plugins at runtime
dirlist=
while read pattern ; do
    ## Ensure absolute path
    case "${pattern}" in
    /*)
        ## Absolute path pattern
        ;;
    \[PLUGINHOME\]*)
        ## Plugin home relative pattern
        pattern="${PLUGINHOME}${pattern#\[PLUGINHOME\]}"
        ;;
    *)
        ## Relative pattern
        pattern="${CONFDIR}/${pattern}"
        ;;
    esac

    # TODO Fix patterns with spaces?
    if [[ "${pattern}" = */ ]]; then
        pattern="${pattern}*.so"
    fi

    ## Resolve pattern and collect directories
    while read pluginfilename ; do
        if test -f "${pluginfilename}"; then
            dir=${pluginfilename%/*}
#            echo "Plugin found: ${pluginfilename}"
            dirlist="${dirlist}${dir}${SEPARATOR}"
        fi
    done < <(ls -1 ${pattern} 2>/dev/null | grep '\.so$')
done < <(grep 'pluginpathes' < "${CONFDIR}/${CONFFILE}" | sed -e 's/^[ \t]*pluginpathes:[ \t]*\(.*\)/\1/' -e 's/|/\n/g')
#echo


## Assemble directory list for LD_LIBRARY_PATH
RELACSPLUGINPATHES=
while read dir ; do
    if test "x${dir}" = x; then
        continue
    fi
    RELACSPLUGINPATHES="${RELACSPLUGINPATHES}${dir}:"
done < <(sed "s/${SEPARATOR}/\n/g" <<< ${dirlist} | sort -u)

echo ">$RELACSPLUGINPATHES<"
exit 0


# set the library path:
export LD_LIBRARY_PATH="${RELACSLIBPATHS}${RELACSPLUGINPATHES}${LD_LIBRARY_PATH}"

# working path:
cd "$WORKPATH"

# run RELACS:
if test "x$USELOGFILE" = "xyes" && test "x$LOGFILE" != "x"; then

  # write RELACS output into logfile
  
  # append old log-file to $LOGFILE.old:
  if test -f "$LOGFILE"; then
    cat $LOGFILE >> $LOGFILE.old
  fi

  # create new log-file:
  echo > $LOGFILE
  echo >> $LOGFILE
  echo "NEW RUN" >> $LOGFILE
  date >> $LOGFILE
  echo >> $LOGFILE

  # execute RELACS:
  if test "x$USETEE" = "xyes"; then
    "$RELACSEXEC" -s "${CONFPART}" $@ 2>&1 | $TEE $LOGFILE
  else
    "$RELACSEXEC" -s "${CONFPART}" $@ >> $LOGFILE 2>&1
  fi

else

  # do not write RELACS output into logfile

  if test "x$DEBUG" = "xyes"; then

    # debug RELACS

    if test "x$COREFILE" != "x"; then

      # run debugger on coredump:
      $DEBUGGER "$RELACSEXEC" "$COREFILE"

    else
 
      if test "x$DEBUGRUN" = "xyes"; then
        # start debugger with RELACS:
        $DEBUGGER --args "$RELACSEXEC" -s "${CONFPART}" $@
      else
        # run RELACS from within debugger:
        DEBUGCOM=relacsdebug$$
        echo "run" > $DEBUGCOM
        $DEBUGGER -x $DEBUGCOM --args "$RELACSEXEC" -s "${CONFPART}" $@
        rm $DEBUGCOM
      fi

    fi

    exit 0

  else

    # simply execute RELACS:
    "$RELACSEXEC" -s "${CONFPART}" $@

  fi

fi

SAVEDLOG="no"

# core dumps:
if test "x$COREDUMP" = "xyes"; then
  CF=$(ls -rtd core* | tail -n 1)
  if test -f "$CF"; then
    NCF=$COREDIR/core.$(date --iso-8601=sec)${CF#core}
    mkdir -p $COREDIR
    mv $CF $NCF
    if test "x$LOGFILE" != "x" && test -f "$LOGFILE"; then
      cp $LOGFILE $COREDIR/$LOGFILE.$(date --iso-8601=sec)
      egrep 'error|warning|panic|Xlib' $LOGFILE > tmp.txt
      SAVEDLOG="yes"
    fi
    if test "x$KERNELMESSAGES" = "xyes"; then
      dmesg > $COREDIR/dmesg.$(date --iso-8601=sec)
    fi
    if test "x$EMAILADDRESS" != "x"; then
      { echo
        echo "RELACS crashed with a core dump!"
	echo
        echo "You find the core dump in"
        echo "  $NCF"
        echo "and the corresponding log-file in"
        echo "  $COREDIR/$LOGFILE.$(date --iso-8601=sec)"
        if test "x$KERNELMESSAGES" = "xyes"; then
          echo "and the kernel messages in"
          echo "  $COREDIR/dmesg.$(date --iso-8601=sec)"
        fi
        echo
        if test "$(wc -l tmp.txt | awk '{print $1}' )" -gt 0; then
          echo "The log-file contains the following warnings and error messages:"
          echo
          cat tmp.txt
        else
          echo "The log-file contains no warnings or error messages."
        fi
        echo
        echo "This email was automatically generated from the 'relacs' script"
        echo "  $0"
        echo "The current working directory is"
        echo "  $PWD"
        echo
      } | mail -s "$COREMAILSUBJ" "$EMAILADDRESS"
    fi
    rm -f tmp.txt
  fi
fi

# bugs:
if test "x$BUGS" = "xyes" && test "x$LOGFILE" != "x" &&
   test -f "$LOGFILE" && test "x$SAVEDLOG" = "xno"; then
  egrep 'error|warning|panic|Xlib' $LOGFILE > tmp.txt
  if test "$(wc -l tmp.txt | awk '{print $1}' )" -gt 0; then
    mkdir -p $BUGDIR
    cp $LOGFILE $BUGDIR/$LOGFILE.$(date --iso-8601=sec)
    if test "x$KERNELMESSAGES" = "xyes"; then
      dmesg > $BUGDIR/dmesg.$(date --iso-8601=sec)
    fi
    if test "x$EMAILADDRESS" != "x"; then
      { echo
        echo "RELACS terminated with bugs!"
        echo
        echo "You find the log-file in"
        echo "  $BUGDIR/$LOGFILE.$(date --iso-8601=sec)"
        if test "x$KERNELMESSAGES" = "xyes"; then
          echo "and the kernel messages in"
          echo "  $BUGDIR/dmesg.$(date --iso-8601=sec)"
        fi
        echo
        echo "The log-file contains the following warnings and error messages:"
        echo
        cat tmp.txt
        echo
        echo "This email was automatically generated from the 'relacs' script"
        echo "  $0"
        echo "The current working directory is"
        echo "  $PWD"
        echo
      } | mail -s "$BUGMAILSUBJ" "$EMAILADDRESS"
    fi
  fi
  rm -f tmp.txt
fi

