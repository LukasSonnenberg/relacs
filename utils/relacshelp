#!/bin/bash

###############################################################################
#
# relacshelp
# 
#
# RELACS - Relaxed ELectrophysiological data Acquisition, Control, and Stimulation
# Copyright (C) 2002-2012 Jan Benda <benda@bio.lmu.de>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
# 
# RELACS is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
###############################################################################

# --help and --version:
if test "x$1" = "x--help"; then
  echo ""
  echo "Usage:"
  echo "  relacshelp <srcdir> <destpath> <pluginset>"
  echo ""
  echo "Extract help files for relacs plugins"
  echo "from their doxygen html documentation in <srcdir>"
  echo "and puts them as well as all image files into <destdir>."
  echo "If <pluginset> is not empty, it is added to the front of the filename."
  echo ""
  echo "Example:"
  echo "> relacshelp common/doc/html help common"
  echo "This will take, for example, common/doc/html/classSpikeDetector.html"
  echo "and create the help file help/common-SpikeDetector.html"
  echo ""
  exit 0
elif test "x$1" = "x--version"; then
  echo "relacshelp 1.0"
  echo "Copyright (C) 2008 Jan Benda"
  exit 0
fi

SRCDIR="$1"
if test "x$SRCDIR" = "x"; then
  echo "Please specify a source directory containing the html class-documentation generated by doxygen."
  echo "For more info try relacshelp --help"
  exit 1
fi
shift
SRCDIR="${SRCDIR%/}"

HELPDIR="$1" 
if test "x$HELPDIR" = "x"; then
  echo "Please specify a destination directory for the generated help pages."
  echo "For more info try relacshelp --help"
  exit 1
fi
shift
HELPDIR="${HELPDIR%/}"

PLUGINSET="$1" 
if test "x$PLUGINSET" != "x"; then
  PLUGINSET="${PLUGINSET%-}-"
fi
shift


# create help files:
echo ""
LASTFILE=""
for DOXYFILE in $SRCDIR/class*.html; do
  FILENAME=${DOXYFILE%.html}
  CLASSNAME=${FILENAME#$SRCDIR/class}
  CLASSNAME=${CLASSNAME%-*}
  CLASSNAME=${CLASSNAME##*_1}
  if test "$CLASSNAME" != "es" && test "$CLASSNAME" != "$LASTFILE"; then
    echo "create help file for ${PLUGINSET}${CLASSNAME}..."
    { echo "<html><body>"
	echo "<h2>$CLASSNAME [$(sed -n  -e '/^\[.*\]/{s/^\[\(.*\)\].*/\1/; p;}' $DOXYFILE)]</h2>"
	sed -n -e '/^\[.*\]/s/^\[.*\]\s*//; /<hr><a name="_details"/,/<hr>/p' $DOXYFILE | sed "1d; \$s/<hr>.*//; s/\\(<img.*\\)src=\"\\(.*\\)\"/\\1src=\"${PLUGINSET}\2\"/"
	echo "</body></html>"; 
    } > ${HELPDIR}/${PLUGINSET}${CLASSNAME}.html
    LASTFILE="$CLASSNAME"
  fi
done

# copy image files:
for IMAGE in $SRCDIR/*.jpg $SRCDIR/*.png; do
  if test -f $IMAGE && test "x${IMAGE##*/}" != "xdoxygen.png" && \
     test $(expr match "x${IMAGE##*/}" '.*__graph.*\.png') == "0" && \
     test $(expr match "x${IMAGE##*/}" '.*dep.png') == "0" && \
     test $(expr match "x${IMAGE##*/}" '.*legend.png') == "0"; then
    echo "copy image file ${PLUGINSET}${IMAGE##*/} ..."
    cp $IMAGE  $HELPDIR/${PLUGINSET}${IMAGE##*/}
  fi
done

echo "DONE"
exit 0

